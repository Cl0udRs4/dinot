C2 系统 PRD 文档

1. 项目概述

项目名称： 红队测试用 C2 系统
开发语言： golang
系统架构： 模块化设计，便于后续扩容与升级
主要组件： Server、Builder、Client Template
目标场景： 红队测试、渗透测试、对抗演练
主要特性：
	•	支持多协议监听（TCP、UDP、WS、ICMP、DNS）
	•	加密方式可选（AES、ChaCha20）
	•	多种控制方式（Console、HTTP API）
	•	客户端具备心跳、模块下发、注册、调用、卸载等功能
	•	Builder 工具用于生成定制化客户端

2. 项目目标与价值

2.1 目标
	•	灵活性与扩展性： 采用模块化设计，各功能模块独立开发，后续扩展更简单；支持动态加载和热更新。
	•	隐蔽性与安全性： 通过多协议支持、流量伪装、随机心跳等机制，降低被检测风险。
	•	易用性： 提供命令行 Builder 工具，实现快速定制与部署；Server 提供丰富的控制接口。
	•	高性能： 采用异步/事件驱动模型，确保在高并发场景下系统稳定运行。

2.2 价值
	•	提供一款高效、灵活且隐蔽的 C2 工具，满足红队在对抗演练和渗透测试中的需求。
	•	通过模块化设计，方便后续扩展新协议、加密方式和功能模块，降低维护成本。

3. 用户与使用场景

3.1 目标用户
	•	红队运维人员
	•	渗透测试团队
	•	安全研究人员

3.2 使用场景
	•	内网隐蔽通信与远程控制
	•	多协议环境下的渗透测试
	•	针对特定目标的快速部署与指令下发
	•	动态调整客户端通信策略以规避检测
4. 系统架构

4.1 总体架构图

（建议绘制一个模块图，展示 Server、Builder 和 Client 之间的关系以及各自内部模块化架构）

4.2 主要组件描述

4.2.1 Server
	•	功能： 集中控制客户端，负责心跳管理、模块下发、注册、调用与卸载。
	•	特性：
	•	多协议监听：支持 TCP、UDP、WS、ICMP、DNS 等。
	•	多控制接口：Console 与 HTTP API。
	•	指令下发：支持动态切换客户端协议，模块指令远程下发。
	•	安全控制：内置认证、权限控制、日志记录和流量混淆。

4.2.2 Builder
	•	功能： 根据用户配置生成定制化的 Client 可执行文件。
	•	命令示例：
	builder -protocol tcp,dns -domain test.com -servers 127.0.0.1:8080,127.0.0.1:53 -modules shell
		•	特性：
	•	根据命令行参数定制内置协议、服务器地址与模块。
	•	内置版本控制、签名校验及调试开关。
	•	自动化测试与持续集成支持。

4.2.3 Client Template
	•	功能： 客户端模板，内置协议模块、加密方式、模块调用逻辑。
	•	特性：
	•	支持自动超时切换协议（如 TCP 和 DNS 间的切换）。
	•	心跳模块：允许配置心跳时间（1s～24h）并随机调整，防止流量特征被识别。
	•	模块化：支持动态加载、调用、下发和卸载各类模块（如 shell 模块）。
5. 功能需求

5.1 Server 功能需求
	1.	多协议监听器
	•	实现 TCP、UDP、WS、ICMP、DNS 协议的监听。
	•	支持灵活配置监听端口和参数。
	2.	控制接口
	•	Console 模式： 提供命令行交互接口。
	•	HTTP API： 提供 RESTful API 接口，实现命令下发、状态查询、日志获取等操作。
	•	接口需实现身份认证与权限管理。
	3.	客户端管理
	•	心跳检测： 定时检测客户端状态，支持 1s～24h 间任意配置，并随机增减时间。
	•	模块管理： 下发模块加载、调用、卸载指令；支持动态指令下发与反馈机制。
	•	注册管理： 客户端注册、状态更新、异常上报机制。
	4.	日志与监控
	•	分级记录操作日志（调试、信息、告警、错误）。
	•	异常检测与报警，支持自动重连与故障恢复。
5.2 Client 功能需求
	1.	多协议支持
	•	根据 Builder 配置支持内置 TCP、UDP、WS、ICMP、DNS 等协议。
	•	自动超时检测与协议切换机制；支持 server 下发的协议切换命令。
	2.	加密通信
	•	提供 AES 与 ChaCha20 两种加密算法供用户选择。
	•	支持密钥协商与定期更新机制。
	3.	心跳机制
	•	可配置心跳时间，支持随机延时调整。
	•	当采用 DNS 协议时，需特别支持心跳功能。
	4.	模块化设计
	•	内置模块（如 shell 模块），支持动态加载、调用与卸载。
	•	实现模块间的解耦，接口统一，便于后续扩展其他功能模块。
	5.	通信反馈
	•	执行 server 下发指令后，返回执行结果与状态反馈。
	•	错误处理与自动重试机制。
5.3 Builder 工具需求
	1.	命令行参数解析
	•	支持参数：-protocol（协议列表）、-domain（域名配置）、-servers（服务器地址列表）、-modules（模块列表）。
	•	提供帮助与版本信息。
	2.	定制化构建
	•	根据用户参数，动态生成内置协议、服务器列表和模块。
	•	支持内置加密算法选择（AES/ChaCha20）。
	3.	安全校验
	•	生成文件需签名校验，保证完整性与安全性。
	•	支持构建过程中的日志输出与错误提示。
	4.	自动化集成
	•	集成自动化测试，确保构建后客户端功能完整且无明显漏洞。
	•	支持持续集成/持续部署（CI/CD）流水线。

6. 系统架构与模块化设计

6.1 模块化设计原则
	•	解耦与接口统一： 每个功能模块实现统一的接口，降低各模块间耦合度。
	•	动态加载： 支持模块在运行时的加载、卸载和更新。
	•	灵活扩展： 新协议、新加密方式、新模块只需实现相应接口即可集成。

6.2 核心模块
	•	协议模块： TCP、UDP、WS、ICMP、DNS 监听器及通信处理逻辑。
	•	加密模块： AES、ChaCha20 加密解密逻辑。
	•	控制接口模块： Console 接口与 HTTP API 交互处理。
	•	客户端管理模块： 心跳检测、注册、指令下发与反馈机制。
	•	日志与监控模块： 日志记录、异常报警与监控数据统计。
	•	Builder 解析模块： 参数解析、构建流程控制及安全校验。
7. 通信协议与加密策略

7.1 通信协议
	•	支持协议： TCP、UDP、WebSocket（WS）、ICMP、DNS
	•	协议特点：
	•	TCP/UDP： 适用于常规数据传输。
	•	WS： 适用于浏览器环境下的通信。
	•	ICMP： 用于隐蔽数据传输。
	•	DNS： 伪装成正常 DNS 查询，降低检测风险。
	•	协议切换：
	•	客户端支持根据超时自动切换内置的多种协议。
	•	Server 可下发切换指令，实时调整客户端通信方式。

7.2 加密策略
	•	算法选择： 提供 AES 与 ChaCha20 两种加密方式。
	•	密钥管理：
	•	支持初次协商和定期更换密钥，避免静态密钥风险。
	•	建议在配置中增加密钥长度、更新周期等选项。
	•	数据加密：
	•	全链路加密，确保通信数据不被窃听或篡改。
	•	对异常数据进行日志记录与报警。

8. 控制与管理接口

8.1 Server 控制接口
	•	Console 接口：
	•	命令行操作，实时接收输入命令。
	•	支持模块管理、客户端监控、日志查询、指令下发等操作。
	•	HTTP API：
	•	基于 RESTful 设计，提供下发指令、状态查询、日志检索等接口。
	•	接口应当支持认证与权限控制，确保只有授权用户能进行操作。

8.2 指令与反馈机制
	•	指令下发：
	•	Server 下发指令后，客户端需按指令加载/调用/卸载相应模块。
	•	支持指令队列和重试机制。
	•	反馈机制：
	•	客户端执行指令后实时返回状态与执行结果。
	•	Server 端记录反馈信息，便于后续统计与故障排查。

9. 客户端管理

9.1 心跳机制
	•	配置范围： 支持 1s 至 24h 的任意配置。
	•	随机调整： 增加或减少随机时间，防止心跳模式固定被检测。
	•	超时切换： 心跳超时后自动尝试切换其他内置协议，保持连接稳定性。

9.2 模块注册与控制
	•	注册： 客户端启动后向 Server 注册自身信息及支持模块。
	•	模块调用： Server 下发调用指令后，客户端加载指定模块（如 shell 模块），并执行相关操作。
	•	模块卸载： 根据需要，支持下发模块卸载指令，及时清理不再需要的模块。

10. Builder 工具详细设计

10.1 参数解析
	•	必选参数：
	•	-protocol：内置协议列表（如 tcp,dns）
	•	-domain：域名配置
	•	-servers：服务器地址列表（支持多个地址及端口）
	•	-modules：内置模块列表（如 shell）
	•	可选参数：
	•	加密方式选择（AES 或 ChaCha20）
	•	调试开关、版本号、签名校验参数

10.2 构建流程
	•	代码定制： 根据命令参数自动配置客户端代码，决定内置协议、模块及加密算法。
	•	编译打包： 编译生成最终可执行文件，附带必要的配置文件与签名。
	•	自动测试： 构建后运行自动化测试，确保各功能模块正常工作。
11. 非功能性需求

11.1 性能要求
	•	高并发情况下支持数百个客户端同时在线。
	•	低延时指令下发与反馈，保证实时性。

11.2 安全性要求
	•	全链路加密，防止数据泄露。
	•	接口认证与权限管理，防止未授权访问。
	•	流量混淆与随机心跳，降低被检测风险。

11.3 可扩展性与可维护性
	•	模块化设计，便于后续添加新协议、加密方式及功能模块。
	•	动态加载与热更新机制，减少系统停机时间。
	•	完善的日志与监控，便于问题排查和系统维护。

12. 项目计划与里程碑

12.1 主要里程碑
	1.	需求调研与方案设计：
	•	完成 PRD 文档
	•	确定系统架构与技术选型
	2.	核心模块开发：
	•	Server 多协议监听、控制接口与日志模块
	•	Client 模块化设计、心跳机制与加密模块
	•	Builder 参数解析与定制化构建
	3.	系统集成与测试：
	•	集成各模块，进行自动化测试与手动测试
	•	性能测试与安全验证
	4.	Beta 版本发布与反馈收集
	•	内部测试并收集反馈
	•	修复问题、优化体验
	5.	正式版本发布与文档完善
	•	完成所有文档、用户手册与维护指南
	•	部署及运维支持
	