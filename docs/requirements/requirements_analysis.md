# C2 系统需求分析文档

## 1. 业务场景分析

### 1.1 红队测试场景
- **内网渗透**：在目标内网环境中部署客户端，通过多种协议（TCP、UDP、WS、ICMP、DNS）建立与控制服务器的隐蔽通信通道，实现远程控制和数据回传。
- **持久化控制**：通过心跳机制（1s～24h随机延时）保持与客户端的稳定连接，同时降低被检测风险。
- **协议切换**：当某种通信协议被阻断时，自动切换到其他可用协议，确保通信持续性。

### 1.2 渗透测试场景
- **快速部署**：使用Builder工具根据目标环境特点快速生成定制化客户端，适应不同网络环境。
- **模块化操作**：根据渗透测试需求，动态加载、调用和卸载不同功能模块（如shell模块），灵活应对各种测试场景。
- **数据回传**：安全加密传输收集的信息，确保数据不被拦截或篡改。

### 1.3 对抗演练场景
- **隐蔽通信**：通过流量混淆、随机心跳等机制，降低被蓝队检测的风险。
- **多协议支持**：在不同网络限制环境下，利用多种协议（特别是ICMP、DNS）绕过防火墙限制。
- **安全控制**：全链路加密、接口认证和权限管理，确保只有授权人员能操作系统。

## 2. 用户故事

### 2.1 红队运维人员
- 作为红队运维人员，我希望能通过简单的命令行界面控制多个客户端，以便高效管理渗透测试资源。
- 作为红队运维人员，我需要查看所有客户端的状态和心跳信息，以便及时发现异常并采取措施。
- 作为红队运维人员，我希望能通过HTTP API远程控制系统，以便在不同位置进行操作。

### 2.2 渗透测试团队
- 作为渗透测试人员，我需要快速生成适合目标环境的客户端，以便高效开展测试工作。
- 作为渗透测试人员，我希望能动态加载不同功能模块，以便根据测试进展调整策略。
- 作为渗透测试人员，我需要系统能在通信协议被阻断时自动切换，以确保测试持续性。

### 2.3 安全研究人员
- 作为安全研究人员，我希望系统提供详细的日志记录，以便分析通信模式和攻防对抗效果。
- 作为安全研究人员，我需要系统支持自定义模块开发，以便测试新的攻击技术。
- 作为安全研究人员，我希望能评估不同协议和加密方式的性能与隐蔽性，以优化未来的工具设计。

## 3. 功能模块描述

### 3.1 Server模块
- **多协议监听器**：支持TCP、UDP、WS、ICMP、DNS协议，每个协议使用独立goroutine处理，支持动态配置。
- **客户端管理**：负责客户端注册、状态更新、心跳检测（1s～24h随机延时）和异常上报。
- **控制接口**：提供Console模式（命令行交互）和HTTP API（RESTful接口，支持JWT/Basic Auth认证）。
- **日志与监控**：实现分级日志记录（调试、信息、告警、错误）和异常报警机制。

### 3.2 Client模块
- **多协议支持**：内置TCP、UDP、WS、ICMP、DNS协议，支持自动超时检测与协议切换。
- **加密通信**：提供AES与ChaCha20两种加密算法，支持密钥协商与定期更新。
- **心跳机制**：可配置心跳时间，支持随机延时调整，降低被检测风险。
- **模块化设计**：支持动态加载、调用和卸载功能模块，确保接口统一、模块解耦。
- **通信反馈**：执行server下发指令后，返回执行结果与状态反馈，支持错误处理与自动重试。

### 3.3 Builder工具
- **命令行参数解析**：支持必选参数（-protocol, -domain, -servers, -modules）和可选参数（加密方式、调试开关等）。
- **定制化构建**：根据用户参数，动态生成内置协议、服务器列表和模块的客户端代码。
- **安全校验**：生成文件需签名校验，保证完整性与安全性。
- **自动化集成**：支持自动化测试和CI/CD流水线。

## 4. 核心特性描述

### 4.1 高隐蔽性
- **多协议支持**：通过支持多种协议（特别是ICMP、DNS），降低通信被检测风险。
- **流量混淆**：对通信数据进行混淆处理，使其难以被识别为C2流量。
- **随机心跳**：心跳间隔随机调整，避免形成固定通信模式。

### 4.2 高灵活性
- **模块化设计**：各功能模块独立开发，接口统一，便于扩展和维护。
- **动态加载**：支持运行时加载、调用和卸载模块，无需重启客户端。
- **多控制方式**：提供Console和HTTP API两种控制接口，适应不同使用场景。

### 4.3 高安全性
- **全链路加密**：使用AES或ChaCha20加密算法保护通信数据。
- **密钥管理**：支持密钥协商和定期更新，降低密钥泄露风险。
- **接口认证**：控制接口实现身份认证与权限管理，防止未授权访问。

### 4.4 高性能
- **异步/事件驱动**：采用goroutine和channel实现异步处理，提高并发性能。
- **资源优化**：合理控制资源使用，确保在资源受限环境中稳定运行。
- **错误处理**：完善的错误处理和自动重试机制，提高系统稳定性。
