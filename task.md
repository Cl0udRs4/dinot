一、项目总体规划与工作流概述
	•	项目名称： 红队测试 C2 系统（Golang 版本）
	•	目标： 利用 Golang 的高并发及内置网络库优势，实现模块化设计、动态加载与热更新，保证系统高效、隐蔽、易扩展。
	•	关键要求：
	•	每个模块、每个功能点在开发后必须通过单元测试（go test）与实际编译测试（go build）。
	•	开发、测试、集成、发布全流程均使用 CI/CD 工具（如 GitLab CI、GitHub Actions）自动执行测试与构建。
	•	工作流阶段：
	1.	需求调研与架构设计
	2.	核心模块开发与单元测试
	3.	系统集成、集成测试与性能安全测试
	4.	Beta 版本发布与反馈优化
	5.	正式版本发布、文档完善与持续支持

二、详细开发工作流

阶段 1：需求调研与架构设计

1.1 需求调研与确认
	•	任务：
	•	复盘现有 C 语言版本 PRD，识别所有功能点、模块间依赖及核心特性（多协议、加密、心跳、模块管理等）。
	•	与红队、渗透测试和安全研究团队进行讨论，明确业务场景及安全要求。
	•	输出：
	•	详细需求文档（含业务场景、用户故事和具体功能描述）。
	•	初步模块划分和接口设计草图（Server、Client、Builder）。
	•	检查点：
	•	需求文档经团队讨论确认后签字定稿。
	•	初步架构图（建议采用工具如 draw.io）完成并存档。

1.2 技术选型与架构设计
	•	任务：
	•	选择 Golang 开发库：
	•	网络：net、net/http、gorilla/websocket（WS）
	•	加密：使用 Go 标准库（crypto/aes、golang.org/x/crypto/chacha20poly1305）
	•	日志：logrus 或 zap 等成熟日志库
	•	动态加载：参考 Go 插件机制或采用自定义模块注册方案
	•	绘制详细的系统架构图，明确数据流、模块间通信和接口协议。
	•	设计各模块的接口与数据结构，制定代码规范和测试标准（包括 go test 脚本格式、覆盖率要求）。
	•	输出：
	•	完整的架构设计文档和模块接口说明书。
	•	编码规范、单元测试和集成测试指南。
	•	检查点：
	•	架构文档需通过技术评审，并生成 README、wiki 文档存储于代码仓库。

阶段 2：核心模块开发与单元测试

本阶段针对 Server、Client、Builder 三大核心模块分别进行详细开发，每个功能模块在实现后都要进行 go test 测试和 go build 测试。

2.1 Server 模块开发
	•	2.1.1 多协议监听器
	•	任务：
	•	编写 TCP、UDP、WS、ICMP、DNS 监听服务，每个协议使用独立 goroutine 处理。
	•	提供统一的监听配置接口，支持热加载新协议模块。
	•	测试要求：
	•	编写 go test 单元测试用例，模拟各协议的请求与响应，确保监听器启动、错误处理、并发连接均正常。
	•	每次改动后通过 go build 检查编译无误。
	•	2.1.2 控制接口
	•	任务：
	•	实现 Console 模式：开发基于命令行的管理工具，可实时输入命令，下发指令、查询日志、管理模块。
	•	实现 HTTP API：利用 net/http 构建 RESTful 接口，加入 JWT 或 Basic Auth 认证，完成客户端状态查询、指令下发、日志查询等功能。
	•	测试要求：
	•	针对 Console 模式编写模拟输入的测试脚本；对 HTTP API 编写端到端测试用例，确保每个 API 接口的正确响应。
	•	使用 go test 脚本测试各接口功能，并通过 go build 进行实际编译构建。
	•	2.1.3 客户端管理与心跳检测
	•	任务：
	•	实现客户端注册、状态更新、心跳检测逻辑，采用定时器和随机延时策略。
	•	设计心跳检测模块，支持配置范围在 1s 到 24h，并在超时后通知调度机制自动切换协议。
	•	测试要求：
	•	单元测试覆盖心跳时间、随机调整逻辑和超时切换逻辑。
	•	模拟客户端注册及状态上报，保证 go test 脚本正常通过。
	•	2.1.4 日志与监控模块
	•	任务：
	•	集成分级日志系统，实现调试、信息、告警、错误四级日志记录。
	•	开发异常检测模块，支持自动重连与故障恢复。
	•	测试要求：
	•	编写测试用例验证日志记录、日志级别过滤与异常报警逻辑。
	•	通过 go test 对日志模块进行全面验证，并确保 go build 无编译错误。

2.2 Client 模块开发
	•	2.2.1 多协议支持与自动切换
	•	任务：
	•	根据 Builder 的配置，实现客户端内置 TCP、UDP、WS、ICMP、DNS 支持。
	•	开发协议超时检测与自动切换机制，利用上下文管理和定时器实现超时切换。
	•	测试要求：
	•	编写 go test 单元测试模拟协议切换场景，确保每个协议的请求与响应正常。
	•	结合 go build 进行实时构建验证。
	•	2.2.2 加密通信模块
	•	任务：
	•	实现 AES 与 ChaCha20 加密/解密函数，并设计密钥协商与定期更新机制。
	•	支持全链路加密，防止数据泄露与篡改。
	•	测试要求：
	•	针对加密解密函数编写单元测试，验证不同密钥、加密方式下的正确性。
	•	执行 go test，确保所有测试覆盖密钥更新和异常情况处理。
	•	2.2.3 心跳与模块化设计
	•	任务：
	•	实现可配置心跳模块（包括随机延时、超时切换）。
	•	设计并实现模块化接口，支持动态加载、调用与卸载各类模块（如 shell 模块）。
	•	测试要求：
	•	单元测试覆盖心跳间隔、模块加载与卸载流程，保证异常处理与反馈正确。
	•	验证所有功能通过 go test，确保通过 go build 构建无误。

2.3 Builder 工具开发
	•	2.3.1 命令行参数解析
	•	任务：
	•	使用 flag 或 cobra 框架实现命令行解析，支持必选参数（-protocol, -domain, -servers, -modules）和可选参数（加密方式、调试开关等）。
	•	编写帮助、版本信息输出及参数校验逻辑。
	•	测试要求：
	•	编写单元测试模拟各种命令行输入，确保解析正确、错误提示准确。
	•	用 go test 验证参数解析模块，同时通过 go build 构建工具。
	•	2.3.2 定制化构建与安全校验
	•	任务：
	•	根据参数生成定制化客户端代码模板，自动注入服务器地址、内置协议、加密方式和模块列表。
	•	集成自动化签名校验与版本控制逻辑，确保构建文件完整性。
	•	结合 go build 自动编译打包生成可执行文件。
	•	测试要求：
	•	编写集成测试，确保构建流程正确执行，生成的客户端可执行文件能够正常启动并与 Server 通信。
	•	运行 go test 脚本模拟构建过程，并进行实际 go build 测试。

阶段 3：系统集成与测试

3.1 单元测试与持续集成
	•	任务：
	•	建立统一的单元测试仓库，所有模块的测试脚本均采用 go test 方式执行。
	•	在代码合并前通过 CI/CD 平台自动运行单元测试，要求 100% 单元测试覆盖率（或符合团队最低标准）。
	•	检查点：
	•	每个模块修改后，开发者必须提交 go test 测试报告和 go build 构建日志，CI 系统自动阻断不合格提交。

3.2 模块集成测试
	•	任务：
	•	搭建集成测试环境，模拟真实网络环境下 Server 与多个 Client 的交互。
	•	编写测试脚本验证：
	•	客户端注册与心跳交互
	•	动态模块加载、调用与卸载
	•	控制接口（Console 和 HTTP API）的指令下发及反馈机制
	•	加密通信、协议自动切换的整体流程
	•	测试要求：
	•	所有集成测试均需用 go test 脚本运行，并生成详细日志记录。
	•	实际通过 go build 打包部署测试版本，确保环境配置无误。

3.3 性能与安全测试
	•	任务：
	•	利用性能测试工具（如 Apache Benchmark、wrk）对 Server 模块进行高并发压力测试，验证低延时响应。
	•	进行安全扫描，模拟攻击（如重放攻击、注入攻击）验证全链路加密与认证有效性。
	•	测试要求：
	•	编写性能测试脚本并集成到 CI/CD 流程中，生成测试报告。
	•	安全测试报告需经安全团队评估并存档。


阶段 4：Beta 版本发布与反馈优化

4.1 内部 Beta 版本发布
	•	任务：
	•	在测试环境中部署 Beta 版本，使用 go build 生成稳定版本，并在内部网络分发。
	•	邀请内部团队和安全专家使用，收集使用过程中的 bug、性能瓶颈和用户体验改进意见。
	•	测试要求：
	•	每个 Beta 版本发布前，必须通过所有单元、集成和性能测试。
	•	收集反馈后修正问题，并在修复后重复 go test 与 go build 测试，确保问题完全解决。

4.2 问题修复与系统优化
	•	任务：
	•	根据反馈，修复各模块 bug，优化代码性能和安全机制。
	•	重点关注：网络连接稳定性、动态加载异常处理、日志记录准确性。
	•	测试要求：
	•	所有问题修复后，必须重新执行 go test 脚本和 go build 测试。
	•	优化后的版本需再次经过集成测试和性能测试。

阶段 5：正式发布与文档完善

5.1 正式版本发布
	•	任务：
	•	整合所有模块，最终通过 CI/CD 流程自动打包、构建生成最终版本（go build 成果）。
	•	部署在正式生产环境前，再次进行全链路集成测试和安全验证。
	•	检查点：
	•	发布前生成详细的测试报告和构建日志，确保所有环节无异常。
	•	通过代码审查和自动化测试流程验证后，正式发布版本。

5.2 完善文档与用户手册
	•	任务：
	•	编写详细的部署文档、用户手册和 API 文档（使用工具如 Swagger 生成 HTTP API 文档）。
	•	整理测试报告、构建日志和代码注释，形成维护指南和常见问题解答（FAQ）。
	•	输出：
	•	完整的开发、部署、使用、运维文档上传至代码仓库 Wiki 或单独文档站点。

5.3 后续支持与维护
	•	任务：
	•	建立监控系统和日志报警机制，实时监控生产环境状态。
	•	定期更新、补丁发布和安全漏洞扫描，并根据实际情况进行 go test、go build 持续验证。
	•	检查点：
	•	制定定期回顾计划和版本更新周期，保证系统长期稳定运行。